<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salle de Réunion</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
        }
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 30px;
        }
        .logo {
            display: flex;
            align-items: center;
        }
        .logo-text {
            font-size: 24px;
            font-weight: bold;
            color: #808080;
        }
        .logo-accent {
            color: #ff0000;
        }
        h1 {
            color: #333;
            margin: 0;
        }
        .logout {
            background-color: #6c757d;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .login-section {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 400px;
            margin: 0 auto 30px;
        }
        .main-content {
            display: none;
        }
        .role-switcher {
            margin-bottom: 20px;
            display: none;
        }
        .role-switcher button {
            background-color: #ddd;
            color: #333;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        .role-switcher button.active {
            background-color: #ff0000;
            color: white;
        }
        .role-switcher button:disabled {
            background-color: #eee;
            color: #999;
            cursor: not-allowed;
        }
        .view {
            display: none;
        }
        .view.active {
            display: block;
        }
        form {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 500px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        input, select {
            width: 100%;
            padding: 10px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #ff0000;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            font-size: 16px;
            margin-bottom: 10px;
        }
        button:hover:not(:disabled) {
            background-color: #cc0000;
        }
        .requests-list {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .request-item {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 4px;
        }
        .request-item h3 {
            margin-top: 0;
            color: #333;
        }
        .status {
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 4px;
            color: white;
        }
        .status.pending { background-color: #ffc107; color: #000; }
        .status.to_rh { background-color: #17a2b8; }
        .status.approved { background-color: #28a745; }
        .status.rejected { background-color: #dc3545; }
        .action-buttons {
            margin-top: 10px;
        }
        .action-buttons button {
            width: auto;
            margin-right: 10px;
            padding: 8px 15px;
        }
        .my-requests {
            max-width: 500px;
        }
        .error, .success {
            color: #dc3545;
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            color: #28a745;
            background-color: #d4edda;
        }
        .export-button {
            background-color: #007bff;
            margin-bottom: 20px;
            width: auto;
            padding: 8px 15px;
        }
        .export-button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">
            <span class="logo-text">WKW Automotive <span class="logo-accent">Tunisie</span></span>
        </div>
        <h1>Salle de Réunion</h1>
        <button id="logout-btn" class="logout" style="display: none;">Déconnexion</button>
    </div>

    <div id="login-section" class="login-section">
        <h2>Connexion</h2>
        <form id="login-form">
            <label for="email">Email :</label>
            <input type="email" id="email" name="email" required>
            <label for="password">Mot de passe :</label>
            <input type="password" id="password" name="password" required>
            <button type="submit">Se connecter</button>
            <div id="login-error" class="error" style="display: none;"></div>
        </form>
    </div>

    <div id="main-content" class="main-content">
        <div class="role-switcher" id="role-switcher">
            <button id="demandeur-btn" class="active">Demandeur</button>
            <button id="admin-btn">Admin</button>
            <button id="rh-btn">RH</button>
        </div>

        <div id="demandeur-view" class="view">
            <form id="booking-form">
                <label for="date">Date :</label>
                <input type="date" id="date" name="date" required>
                <label for="nom">Nom du Demandeur :</label>
                <input type="text" id="nom" name="nom" readonly required>
                <label for="objet">Objet de la Demande :</label>
                <input type="text" id="objet" name="objet" required>
                <label for="heureDebut">Heure de Début :</label>
                <input type="time" id="heureDebut" name="heureDebut" required>
                <label for="heureFin">Heure de Fin :</label>
                <input type="time" id="heureFin" name="heureFin" required>
                <label for="salle">Choix de la Salle de Réunion :</label>
                <select id="salle" name="salle" required>
                    <option value="">Sélectionnez une salle</option>
                    <option value="utique">Salle de Réunion Utique</option>
                    <option value="carthage">Salle de Réunion Carthage</option>
                </select>
                <button type="submit">Réserver la Salle</button>
            </form>
            <div class="my-requests">
                <h2>Mes Demandes</h2>
                <div id="requests-list-demandeur"></div>
            </div>
        </div>

        <div id="admin-view" class="view">
            <div class="requests-list">
                <h2>Demande en Attente (Admin)</h2>
                <button id="export-btn" class="export-button">Exporter les Demandes</button>
                <div id="requests-list-admin"></div>
            </div>
        </div>

        <div id="rh-view" class="view">
            <div class="requests-list">
                <h2>Demande Approuvée par Admin (RH)</h2>
                <div id="requests-list-rh"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js';
        import { getDatabase, ref, push, update, onValue } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js';
        import { getFirestore, collection, addDoc, updateDoc, doc, getDocs } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCwp0prUZEWUow2vlzTH2iJ59oIsf5qMr8",
            authDomain: "salle-de-reunion-381fc.firebaseapp.com",
            databaseURL: "https://salle-de-reunion-381fc-default-rtdb.firebaseio.com",
            projectId: "salle-de-reunion-381fc",
            storageBucket: "salle-de-reunion-381fc.firebasestorage.app",
            messagingSenderId: "1008205636137",
            appId: "1:1008205636137:web:8df5e78408075f481ab238",
            measurementId: "G-41P4C3NN5D"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const firestore = getFirestore(app);
        let currentUser = null;
        let currentRole = 'demandeur';
        let requestsData = [];

        const requestsRef = ref(db, 'requests');
        onValue(requestsRef, (snapshot) => {
            requestsData = [];
            if (snapshot.exists()) {
                snapshot.forEach((child) => {
                    requestsData.push({
                        key: child.key,
                        ...child.val()
                    });
                });
            }
            if (currentUser && document.getElementById(currentRole + '-view').classList.contains('active')) {
                if (currentRole === 'demandeur') {
                    loadMyRequests();
                } else {
                    loadRequests(currentRole === 'admin' ? 'pending' : 'to_rh');
                }
            }
        }, (error) => {
            showError('Erreur de chargement des données : ' + error.message, 'main-content');
        });

        onAuthStateChanged(auth, (user) => {
            console.log('Auth state changed:', user ? user.email : 'No user');
            if (user) {
                const email = user.email;
                const username = email.split('@')[0].toLowerCase(); // Lowercase for Firestore consistency
                let role = 'demandeur';
                const emailLower = email.toLowerCase();
                if (emailLower === 'walid.gharbi@wkw-group.com') {
                    role = 'admin';
                } else if (emailLower === 'bedis.sghair@wkw-group.com') {
                    role = 'rh';
                }
                currentUser = { role, username, email };
                console.log('Rôle assigné:', role, 'pour l\'email:', email, 'username:', username);
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
                document.getElementById('logout-btn').style.display = 'inline-block';
                document.getElementById('role-switcher').style.display = 'block';
                document.querySelectorAll('.role-switcher button').forEach(btn => {
                    btn.disabled = btn.id !== `${role}-btn`;
                    btn.classList.toggle('active', btn.id === `${role}-btn`);
                    btn.replaceWith(btn.cloneNode(true));
                    const newBtn = document.querySelector(`#${btn.id}`);
                    newBtn.addEventListener('click', () => switchRole(newBtn.id.replace('-btn', '')));
                });
                if (role === 'demandeur') {
                    document.getElementById('nom').value = username;
                }
                switchRole(role);
            } else {
                currentUser = null;
                document.getElementById('main-content').style.display = 'none';
                document.getElementById('login-section').style.display = 'block';
                document.getElementById('logout-btn').style.display = 'none';
                document.getElementById('role-switcher').style.display = 'none';
                document.getElementById('login-form').reset();
                document.getElementById('login-error').style.display = 'none';
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            }
        });

        document.getElementById('login-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('login-error');
            try {
                await signInWithEmailAndPassword(auth, email, password);
                errorDiv.style.display = 'none';
            } catch (error) {
                errorDiv.textContent = error.message.includes('auth/wrong-password') ? 'Mot de passe incorrect.' : error.message;
                errorDiv.style.display = 'block';
            }
        });

        document.getElementById('logout-btn').addEventListener('click', async function() {
            try {
                await signOut(auth);
            } catch (error) {
                showError('Erreur lors de la déconnexion : ' + error.message, 'main-content');
            }
        });

        document.getElementById('export-btn').addEventListener('click', async function() {
            if (!currentUser) {
                showError('Vous devez être connecté pour exporter les données.', 'admin-view');
                return;
            }
            try {
                const querySnapshot = await getDocs(collection(firestore, 'requests'));
                const csvData = querySnapshot.docs.map(doc => {
                    const data = doc.data();
                    return `"${data.date}","${data.nom}","${data.objet}","${data.heureDebut}","${data.heureFin}","${data.salle}"`;
                });
                const csvContent = 'data:text/csv;charset=utf-8,' +
                    '"Date","Nom du Demandeur","Objet de la Demande","Heure de Début","Heure de Fin","Choix de la Salle de Réunion"\n' +
                    csvData.join('\n');
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement('a');
                link.setAttribute('href', encodedUri);
                link.setAttribute('download', `booking_requests_${new Date().toISOString().split('T')[0]}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (error) {
                showError('Erreur lors de l\'exportation : ' + (error.message.includes('permission') ? 'Permissions insuffisantes.' : error.message), 'admin-view');
            }
        });

        document.getElementById('booking-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!currentUser || currentUser.role !== 'demandeur') {
                showError('Vous devez être connecté en tant que demandeur.', 'demandeur-view');
                return;
            }
            const formData = new FormData(this);
            const request = {
                date: formData.get('date'),
                nom: currentUser.username, // Lowercase username
                objet: formData.get('objet'),
                heureDebut: formData.get('heureDebut'),
                heureFin: formData.get('heureFin'),
                salle: formData.get('salle'),
                status: 'pending',
                timestamp: new Date().toISOString()
            };
            console.log('Submitting request:', request, 'for user:', currentUser.email, 'auth.email.split("@")[0]:', currentUser.email.split('@')[0]);
            try {
                const rtPush = await push(requestsRef, request);
                await addDoc(collection(firestore, 'requests'), { ...request, rtKey: rtPush.key });
                showSuccess('Demande soumise ! Elle attend l\'approbation de l\'admin.', 'booking-form');
                this.reset();
                document.getElementById('nom').value = currentUser.username;
            } catch (error) {
                console.error('Submission error:', error);
                showError('Erreur lors de la soumission : ' + (error.message.includes('PERMISSION_DENIED') ? 'Permissions insuffisantes.' : error.message), 'booking-form');
            }
        });

        function switchRole(role) {
            if (currentUser.role !== role) return;
            currentRole = role;
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(role + '-view').classList.add('active');
            document.querySelectorAll('.role-switcher button').forEach(b => b.classList.remove('active'));
            document.getElementById(role + '-btn').classList.add('active');
            if (role === 'demandeur') {
                loadMyRequests();
            } else {
                loadRequests(role === 'admin' ? 'pending' : 'to_rh');
            }
        }

        function loadMyRequests() {
            if (!currentUser) return;
            const filtered = requestsData.filter(r => r.nom === currentUser.username);
            const container = document.getElementById('requests-list-demandeur');
            container.innerHTML = '';
            filtered.forEach(req => {
                const div = document.createElement('div');
                div.className = 'request-item';
                div.innerHTML = `
                    <h3>${req.objet}</h3>
                    <p>Date: ${req.date} | Salle: ${req.salle} | ${req.heureDebut} - ${req.heureFin}</p>
                    <span class="status ${req.status}">${getStatusText(req.status)}</span>
                `;
                container.appendChild(div);
            });
        }

        function loadRequests(status) {
            if (!currentUser) return;
            const filtered = requestsData.filter(r => r.status === status);
            const container = document.getElementById(`requests-list-${currentRole}`);
            container.innerHTML = '';
            filtered.forEach(req => {
                const div = document.createElement('div');
                div.className = 'request-item';
                div.innerHTML = `
                    <h3>${req.objet} - ${req.nom}</h3>
                    <p>Date: ${req.date} | Salle: ${req.salle} | ${req.heureDebut} - ${req.heureFin}</p>
                    <span class="status ${req.status}">${getStatusText(req.status)}</span>
                    <div class="action-buttons">
                        <button data-key="${req.key}" data-action="approved">Approuver</button>
                        <button data-key="${req.key}" data-action="rejected">Rejeter</button>
                    </div>
                `;
                container.appendChild(div);
            });
            document.querySelectorAll('.action-buttons button').forEach(button => {
                button.addEventListener('click', () => {
                    const key = button.dataset.key;
                    const action = button.dataset.action;
                    updateStatus(key, action);
                });
            });
        }

        async function updateStatus(key, action) {
            if (!currentUser) {
                showError('Vous devez être connecté.', currentRole + '-view');
                return;
            }
            let newStatus = null;
            if (action === 'approved') {
                newStatus = currentRole === 'admin' ? 'to_rh' : 'approved';
            } else if (action === 'rejected') {
                newStatus = 'rejected';
            }
            if (newStatus) {
                console.log(`Updating status for key: ${key} to: ${newStatus} by: ${currentUser.email}`);
                try {
                    await update(ref(db, `requests/${key}`), { status: newStatus });
                    const querySnapshot = await getDocs(collection(firestore, 'requests'));
                    const docRef = querySnapshot.docs.find(doc => doc.data().rtKey === key);
                    if (docRef) {
                        await updateDoc(doc(firestore, 'requests', docRef.id), { status: newStatus });
                    } else {
                        console.warn(`No Firestore document found for rtKey: ${key}`);
                    }
                    showSuccess(action === 'approved' ? 'Approuvée !' : 'Rejetée !', currentRole + '-view');
                } catch (error) {
                    console.error('Update error:', error);
                    showError('Erreur lors de la mise à jour : ' + (error.message.includes('PERMISSION_DENIED') ? 'Permissions insuffisantes.' : error.message), currentRole + '-view');
                }
            }
        }

        function getStatusText(status) {
            const texts = {
                pending: 'En Attente',
                to_rh: 'En Attente RH',
                approved: 'Approuvée',
                rejected: 'Rejetée'
            };
            return texts[status] || status;
        }

        function showError(message, containerId) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            document.getElementById(containerId).prepend(errorDiv);
            setTimeout(() => errorDiv.remove(), 5000);
        }

        function showSuccess(message, containerId) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            document.getElementById(containerId).prepend(successDiv);
            setTimeout(() => successDiv.remove(), 5000);
        }
    </script>
</body>
</html>
